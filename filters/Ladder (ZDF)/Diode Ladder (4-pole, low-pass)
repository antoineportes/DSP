################################################################
          DIODE LADDER FILTER: 4-pole Low-pass
################################################################

//  Full block diagram

        ---------o<------------------
        |        |                  |
        |      - v  H               |
        |       (+)--->[ 1 / s ]--->o--> y4
        |      + ^                  |
        |        |             G    v -
        |        o<----------------(+)
        |        |                  ^ +
        |      - v  F               |
      [ k ]     (+)--->[ 1 / s ]--->o--> y3
        |      + ^                  |
        |        |             E    v -
        |        o<----------------(+)
        |        |                  ^ +
        |      - v  D               |
        |       (+)--->[ 1 / s ]--->o--> y2
        |      + ^                  |
        |        |             C    v -
        |        o<----------------(+)
        |        |                  ^ +
      - v   A  - v  B               |
  x -->(+)----->(+)--->[ 2 / s ]--->o--> y1

//// How I built this diagram

  It's based upon two sources:
    1) Vadim Zavalishin "The Art of VA filter design" v. 2.1.2 p202
    2) Schematics of the Roland TB-303 VCF

  I've ignored the non-linearities in Vadim's block diagram, then added some modifications to have it better reflect the (ideal) analog model.
  First it's upside-down (input at the bottom output at the top) because all schematics I've found display the ladder this way.
  Then I understood the reason for the halving gains (in the book): most Diode ladder VCFs have 4 capacitors in parallel.
  The 2nd, 3rd and 4th ones have equal capacitance and the first one has approximately half this capacitance.
  The cutoff frequency of a 1-pole RC circuit is wc (Hz) = 1 / (2 * pi * R * C), so doubling C is halving the cutoff.
  The cutoff gain can (mathematically) be extracted of the integrator. Which is what Vadim did by adding gains of 1 / 2 before integrators 2 to 4.
  By doing so he also decided that the reference-cutoff was the one of the first filter in the cascade.  This makes sense for high values of k,
  since this frequency is the closest to the resonance peak, but with k -> 0 the curve of the amplitude response looks shifted to the left.
  So no matter which reference you choose, the overall cutoff has to be rescaled according to k.
  Just for fun, I chose to go the other way around: use LP 2, 3 & 4 as reference and double the cutoff in LP 1.


//  Transfer function

  y4 / s  =  H
  H  =  G - y4
  y4 * (s + 1)  =  G
  G  =  y3 + y4
  y4 * (s + 2)  =  y3
  y3  =  F / s
  y4 * (s^2  +  2 * s)  =  F
  F  =  E - G  =  E  -  y4 * (s + 1)
  y4 * (s^2  +  2 * s  +  s  +  1)  =  y4 * (s^2  +  3 * s  + 1)  =  E
  E  =  y2 - y3  =  y2  -  y4 * (s + 2)
  y4 * (s^2  +  3 * s  +  1  +  s  +  2)  =  y4 * (s^2  +  4 * s  +  3)  =  y2
  y2  =  D / s
  y4 * (s^3  +  4 * s^2  +  3 * s)  =  D
  D  =  C - E  =  C  -  y4 * (s^2  +  3 * s  +  1)
  y4 * (s^3  +  4 * s^2  +  3 * s  +  s^2  +  3 * s  +  1)  =  y4 * (s^3  +  5 * s^2  +  6 * s  +  1)  =  C
  C  =  y1 - y2  =  y1  -  y4 * (s^2  +  4 * s  +  3)
  y4 * (s^3  +  5 * s^2  +  6 * s  +  1  +  s^2  +  4 * s  +  3)  =  y4 * (s^3  +  6 * s^2  +  10 * s  +  4)  =  y1
  y1  =  (2 * B) / s
  y4 * (s^4  +  6 * s^3  +  10 * s^2  +  4 * s) / 2  =  y4 * (0.5 * s^4  +  3 * s^3  +  5 * s^2  +  2 * s)  =  B
  B  =  A - C  =  A  -  y4 * (s^3  +  5 * s^2  +  6 * s  +  1)
  y4 * (0.5 * s^4  +  3 * s^3  +  5 * s^2  +  2 * s  +  s^3  +  5 * s^2  +  6 * s  +  1)  =  y4 * (0.5 * s^4  +  4 * s^3  +  10 * s^2  +  8 * s  +  1)  =  A
  A  =  x  -  k * y4
  y4 * (0.5 * s^4  +  4 * s^3  +  10 * s^2  +  8 * s  +  1  +  k)  =  x

                                        1
  H(s)  =  ----------------------------------------------------------
            0.5 * s^4  +  4 * s^3  +  10 * s^2  +  8 * s  +  1  +  k


//  Bode plot

  https://www.desmos.com/calculator/uhsiwvfkgw


//  Further tweaking

  Two things I'like to change:
    1) When there's no (or little) resonance the amplitude at the cutoff frequency is ridiculously low (~= -20 dB). The shape of the curve is nice but
      it looks shifted far left. Offseting the cutoff to compensate should do it, but as soon as there is resonance, I don't want the peak frequency to
      exceed wc. So what I need is a factor for the cutoff that's inversely proportional to k.
    2) When there is resonance, the pass-band attenuation is pretty insane (worse than with a non-normalised transistor ladder)[2]. I need to find the
      amplitude of the pass-band and multiply the input or the output by its inverse. With non-linearities involved, normalising the output means
      less distortion... I'll obviously normalise the input.

  Multiplying the cutoff by some factor will only shift the curve left or right without modifying the pass-band amplitude.
  Normalising the overall amplitude by some factor happens outside of the transfer function and thus won't affect the frequency response (apart from 
  shifting the amplitude up or down).
  This means than the two parameters I need are independant from one another even though they both rely on k.

////  Normalising the pass-band

  Let's start by getting rid of the easy one.
  It's a low-pass, so the pass-band amplitude is the amplitude when w -> 0.

  w = 0  =>  j * w / wc = 0  =>  s = 0

  H(0) = 1 / (1 + k)    ;    abs (1 / (1 + k)  =  sqRt ( sqr ( 1 / (1 + k) ) )  =  1 / (1 + k)
  norm  =  1 / ( 1 / (1 + k) )  =  1 + k

  Done!









