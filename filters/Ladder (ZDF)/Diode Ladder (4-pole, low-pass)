################################################################
          DIODE LADDER FILTER: 4-pole Low-pass
################################################################

//  Full block diagram

           A      B            C      D              y1      E            F      G              y2      H            I      J              y3      K
  x -->(+)--->(+)--->[ 1 / 2 ]--->(+)--->[ 1 / s ]-->o-->(+)--->[ 1 / 2 ]--->(+)--->[ 1 / s ]-->o-->(+)--->[ 1 / 2 ]--->(+)--->[ 1 / s ]-->o-->(+)--->[ 1 / s ]-->o--> y4
        ^ -    ^ +                 ^ -               |    ^ +                 ^ -               |    ^ +                 ^ -               |    ^ -               |
        |      |                   |                 |    |                   |                 |    |                   |                 |    |                 |
        |      |                   -------------------    |                   |                 |    |                   |                 |    |                 |
        |      | (y2)                                     |                   |                 |    |                   |                 |    |                 |
        |      -------------------------------------------|-------------------o<-----------------    |                   |                 |    |                 |
        |                                                 | (y3)                                     |                   |                 |    |                 |
        |                                                 -------------------------------------------|-------------------o<-----------------    |                 |
        |  L (main feedback)                                                                         | (y4)                                     |                 |
        -----------------------[ k ]<----------------------------------------------------------------o<-----------------------------------------o<-----------------


//  Transfer function
////  Steps:
  
  https://www.desmos.com/calculator/eenls3dri8

  (After 3 failed attempts, I realised that the letters on the diagram weren't helping — apart maybe from A.)

////  Result:

                                   1
  H(s)  =  -------------------------------------------------
            8 * (s + 1) ^ 4  -  8 * (s + 1) ^ 2  +  1  +  k


//  Bode plot:

  https://www.desmos.com/calculator/uhsiwvfkgw

  The curve feels faulty: the amplitude at w = wc is less than -30 dB...
  I built my block diagram following instructions from Vadim Zavalishin ("The Art of VA filter design", v. 2.1.2, p. 166).
  So I compared our respective transfer functions and bode plots to see if I went wrong. Turns out what I get is what I'm supposed to get.

  But I don't like this result so I need to tweak Vadim's prototype.


//  Tweaking the prorotype

  So I've searched the internet for schematics, transfer functions and block diagrams that would suggest alternative designs or help me undersatand
  how the author went from the circuit to his block diagram.
  I found schematics for the Roland TB-303 VCF and clones of early EMS VCFs. There are always 4 capacitors in derivation, 3 have equal capacitance
  and one has approximately half the capacitance of the other 3. That explains the 3 halving gains: wc (Hz)  =  1  /  (2 * pi * R * C), so doubling
  C is halving the cutoff.
  In a 1-pole filter, the cutoff gain can (mathematically) be extracted of the integrator and put in front of it. But it's still applied after the
  negative feedback from the output...  (x / 2) - y  !=  (x - y) / 2
  So maybe getting rid of the three halving gains and replacing 1 / s by 1 / (2 * s) in the corresponding integrators would better fit the analog
  models (that would mean replacing wcT/2 by wcT/4 in the digital implementation but I'm not there yet).

  I took the liberty of moving one halving gain from the end to the begining (applied to A + y2 instead of y3) because it didn't affect the whole transfer
  function. Now it does, so let's stupidly follow the schematics.

////  New block diagram
////  SPOILER: failure.

           A                           y1                           y2                            y3       
  x -->(+)--->(+)-->(+)-->[ 1 / s) ]-->o-->(+)-->(+)-->[ 1 / 2s ]-->o-->(+)-->(+)--->[ 1 / 2s ]-->o-->(+)--->[ 1 / 2s ]-->o--> y4
        ^ -    ^ +   ^ -               |    ^ +   ^ -               |    ^ +   ^ -                |    ^ -               |
        |      |     |                 |    |     |                 |    |     |                  |    |                 |
        |      |     -------------------    |     |                 |    |     |                  |    |                 |
        |      | (y2)                       |     |                 |    |     |                  |    |                 |
        |      -----------------------------|-----o<-----------------    |     |                  |    |                 |
        |                                   | (y3)                       |     |                  |    |                 |
        |                                   -----------------------------|-----o<------------------    |                 |
        |  (main feedback)                                               | (y4)                        |                 |
        -----------------------[ k ]<------------------------------------o<----------------------------o<-----------------

////  New transfer function
//////  LP with half cutoff:

  y   =   (x - y) / 2s
  y * 2s  =  x - y
  y * (2s + 1)  =  x
  y / x  =  1 / (2s + 1)

//////  Steps:

  https://www.desmos.com/calculator/wi2wid6cah

//////  Result:

                                     1
  H(s)  =  --------------------------------------------------------
            4 * s^4  +  14 * s^3  +  8 * s^2  -  3 * s  -  1  -  k

//////  Bode plot:

  https://www.desmos.com/calculator/j4pup7mbh0

  Ok, so, nope.

  Vadim's prototype it is!
  Two things I'like to change:
    1) When there's no (or little) resonance the amplitude at the cutoff frequency is ridiculously low. The shape of the curve is nice but it looks
      shifted far left. Offseting the cutoff to compensate should do it, but as soon as there is resonance, I don't wanna offset the resonance peak.
      So what I need is a factor for the cutoff that's inversely proportional to k.
    2) When there is resonance, the pass-band attenuation is pretty insane (worse than with a non-normalised transistor ladder. I need to find the
      amplitude of the pass-band and multiply the input or the output by its inverse. With non-linearities involved, normalising the output means
      less distortion... I'll obviously normalise the input.

  Multiplying the cutoff by some factor will only shift the curve left or right without modifying the pass-band amplitude.
  Normalising the overall amplitude by some factor happens outside of the transfer function and thus won't affect the frequency response (apart from 
  shifting the amplitude up or down).
  This means than the two parameters I need are independant from one another even though they both rely on k.


//// Cutoff offset

  The Roland TB-303 VCF was described by the manufacturer as a 3-pole 18 dB / oct filter. While the schematics clearly show 4 capacitors in parallel,
  so 4 low-pass RC circuits, 1 4-pole filter.

  There are several theories about the reason why. The most recurring being avoiding to infringe Moog's patent...
  I find it very unlikely, for I sincerly hope that, in case of a court action, the investigation digs a bit deeper than user facing product description.
  
  I have my own hypothesis — which is probably false but might serve the currunt perpose:
  the slope takes so long to reach 24 dB / oct that the area of interest is best averaged as 18 dB /oct, which indeed corresponds to order N = 3.

  Ok, so let's say we want that behaviour.
  (I'm temporarily ignoring the negative feedback, so until further notice: k = 0.) 
  The most obvious solution (with which I will start) is to re-scale the cutoff gain so that the amplitude at
  the cutoff frequency is the same as with 3 1-pole LP in series:

  |H(j)|  =  ( 1 / sqRt (2) ) ^ 3  =  1 / ( 2 * sqRt (2) )  =  sqRt (2) / 4  =  sqRt ( 2 / 16 )  =  sqRt ( 1 / 8 )  =  sqRt (0.125)  ~=  0.35355339...

  Since s = j * w / wc [1], scaling the cutoff by a factor "c" (k is already taken... ) is equivalent to dividing s by c, indeed:
  s'  =  j * w / (c * wc)  =>  s' * c  =  j * w / wc  =  s  =>  s'  =  s / c.

  [1] Well in theory s = j * w and we assume wc = 1. Then there are 2 steps to retrieve H(jw): s -> s / wc then s -> j * w (forgive me for taking a shortcut).
  
  So I'm looking for _c = 1 / c that satisfies:
  
  |H(j * _c)|  =  sqRt (1 / 8)    or more conveniently:  |H(j * _c)| ^ -2  =  8          //  (That just means only evaluating the denominator and ignoring the
                                                                                         //  square root from the complex absolute value formula.)







